#!/usr/bin/env bash

# Safer bash settings
set -euo pipefail
IFS=$'\n\t'

TYPE=php
VERSION=5.0.0

# Make harbor command executable if possible
if [[ -w ./harbor ]]; then
  chmod +x ./harbor || true
fi

printVersion() {
    echo "${VERSION}"
}

checkSystemSupport() {
    # check system if supported
    UNAMEOUT="$(uname -s)"
    case "${UNAMEOUT}" in
    Linux*)
        MACHINE=linux
        ;;
    Darwin*)
        MACHINE=mac
        ;;
    MINGW64_NT-10.0*)
        MACHINE=mingw64
        ;;
    *)
        MACHINE="UNKNOWN"
        ;;
    esac

    if [[ "$MACHINE" == "UNKNOWN" ]]; then
        echo "Unsupported system type"
        echo "System must be a Macintosh/Linux/Windows"
        echo ""
        echo "System detection determined via uname command"
        echo "If the following is empty, could not find uname command: $(command -v uname || echo 'not found')"
        echo "Your reported uname is: $(uname -s)"
        exit 1
    fi

    return 0
}

setupEnvVariables() {
    # prepare default env variables

    # source .env.harbor
    if [[ -f .env.harbor ]]; then
        # Temporarily disable nounset to avoid errors on unset vars inside .env.harbor
        set +u
        set -o allexport
        source .env.harbor
        set +o allexport
        set -u
    else
        echo "Harbor .env.harbor file is missing, cannot continue."
        exit 1
    fi

    # create base compose command (prefer docker compose v2, fallback to docker-compose v1)
    if command -v docker >/dev/null 2>&1 && docker compose version >/dev/null 2>&1; then
        COMPOSE=(docker compose -f docker-compose.yml)
    else
        COMPOSE=(docker-compose -f docker-compose.yml)
    fi
    if [[ -f "docker-compose.override.yml" ]]; then
        COMPOSE+=( -f docker-compose.override.yml )
    fi

    # set xdebug host for developing
    if [[ $(docker version --format '{{.Server.Version}}') > 18.03.0 ]]; then
        HARBOR_XDEBUG_HOST=host.docker.internal
    elif [[ "$MACHINE" == "linux" ]]; then
        HARBOR_XDEBUG_HOST=$(/sbin/ifconfig docker0 | grep "inet addr" | cut -d ':' -f 2 | cut -d ' ' -f 1)
    elif [[ "$MACHINE" == "mac" ]]; then
        HARBOR_XDEBUG_HOST=$(ipconfig getifaddr en0) # Ethernet

        if [[ -z "$HARBOR_XDEBUG_HOST" ]]; then
            HARBOR_XDEBUG_HOST=$(ipconfig getifaddr en1) # Wifi
        fi
    elif [[ "$MACHINE" == "mingw64" ]]; then # Git Bash
        HARBOR_XDEBUG_HOST=10.0.75.1
    fi
    export HARBOR_XDEBUG_HOST

    # set sed command (default if machine not matched)
    if [[ "$MACHINE" == "mac" ]]; then
        SEDCMD="sed -i .bak"
    else
        SEDCMD="sed -i"
    fi

    # is the environment running (use selected compose command)
    PSRESULT="$( "${COMPOSE[@]}" ps -q )"
    if [[ -n "$PSRESULT" ]]; then
        EXEC="yes"
    else
        EXEC="no"
    fi
}

touchHistory() {
    # Ensure history directory exists
    mkdir -p ./.harbor/history

    if [[ ! -f ./.harbor/history/harbor_bash_history ]]; then
        touch ./.harbor/history/harbor_bash_history
    fi
    if [[ ! -f ./.harbor/history/root_bash_history ]]; then
        touch ./.harbor/history/root_bash_history
    fi
}

prepareExternalVolumes() {
    # Ensure expected named volumes exist (idempotent)
    if ! docker volume ls -q | grep -qw empty-node-modules; then
        docker volume create --driver local empty-node-modules >/dev/null 2>&1
    fi
    if ! docker volume ls -q | grep -qw empty-vendor; then
        docker volume create --driver local empty-vendor >/dev/null 2>&1
    fi
    if ! docker volume ls -q | grep -qw composer-cache; then
        docker volume create --driver local composer-cache >/dev/null 2>&1
    fi
}

testRunningContainers() {
    if [[ -n $(docker ps -q) ]]; then
        echo "You have some running containers. Are you sure that they are not blocking required ports: $HARBOR_WEB_PORT, $HARBOR_DB_PORT, $HARBOR_DB_TESTING_PORT ?"
        printf "Do you wish to continue (y/n)? "
        local answer
        read -r -n1 answer
        echo ""
        if echo "$answer" | grep -iq "^y"; then
            echo "Continue ..."
            "${COMPOSE[@]}" down
        else
            exit 0
        fi
    fi
}

rebuild() {
    local REMOVE_IMAGES=""
    local REMOVE_VOLUMES=""
    local EXTRA_ARGS=()

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -i|--images)
                REMOVE_IMAGES="--rmi all"
                shift 1
                ;;
            -v|--volumes)
                REMOVE_VOLUMES="-v"
                shift 1
                ;;
            *)
                EXTRA_ARGS+=("$1")
                shift 1
                ;;
        esac
    done

    # Ensure containers are up before rebuild steps
    ./harbor start

    # Bring down with optional volume/image removal
    "${COMPOSE[@]}" down ${REMOVE_VOLUMES} ${REMOVE_IMAGES}

    # Pull latest images
    "${COMPOSE[@]}" pull

    # Build with any extra args (e.g., --no-cache)
    if [[ ${#EXTRA_ARGS[@]} -gt 0 ]]; then
        "${COMPOSE[@]}" build "${EXTRA_ARGS[@]}"
    else
        "${COMPOSE[@]}" build
    fi
}

artisan() {
    if [[ "$EXEC" == "yes" ]]; then
        "${COMPOSE[@]}" exec \
            -u harbor \
            php \
            php artisan "$@"
    else
        "${COMPOSE[@]}" run --rm \
            php \
            php artisan "$@"
    fi
}

composer() {
    if [[ "$EXEC" == "yes" ]]; then
        "${COMPOSE[@]}" exec \
            -u harbor \
            php \
            composer "$@"
    else
        "${COMPOSE[@]}" run --rm \
            php \
            composer "$@"
    fi
}

db() {
    local DB_COMMAND
    if [[ ${HARBOR_DB_CONNECTION} == "pgsql" ]]; then
        DB_COMMAND=(psql -U "${DB_USERNAME}" -h localhost "${DB_DATABASE}")
    elif [[ ${HARBOR_DB_CONNECTION} == "mysql" ]]; then
        DB_COMMAND=(mysql -u "${DB_USERNAME}" -h localhost "${DB_DATABASE}")
    else
        echo "Database ${HARBOR_DB_CONNECTION} not supported in this command."
        return 1
    fi
    if [[ "$EXEC" == "yes" ]]; then
        "${COMPOSE[@]}" exec \
            db \
            "${DB_COMMAND[@]}" "$@"
    else
        "${COMPOSE[@]}" run --rm \
            db \
            "${DB_COMMAND[@]}" "$@"
    fi
}

dump() {
    local DB_COMMAND
    if [[ ${HARBOR_DB_CONNECTION} == "pgsql" ]]; then
        DB_COMMAND=(pg_dump -U "${DB_USERNAME}" -h localhost "${DB_DATABASE}")
    elif [[ ${HARBOR_DB_CONNECTION} == "mysql" ]]; then
        DB_COMMAND=(mysqldump -u "${DB_USERNAME}" -h localhost "${DB_DATABASE}")
    else
        echo "Database ${HARBOR_DB_CONNECTION} not supported in this command."
        return 1
    fi
    if [[ "$EXEC" == "yes" ]]; then
        "${COMPOSE[@]}" exec \
            db \
            "${DB_COMMAND[@]}" "$@"
    else
        "${COMPOSE[@]}" run --rm \
            db \
            "${DB_COMMAND[@]}" "$@"
    fi
}

ssh() {
    # Require a target service name
    if [[ $# -lt 1 ]]; then
        echo "Usage: ./harbor ssh <service> [root]"
        exit 1
    fi

    local service="$1"
    local user_arg=""

    if [[ "$EXEC" == "yes" ]] && [[ "$service" != "node" ]]; then
        if [[ "$service" == "php" ]] && [[ "${2:-}" != "root" ]]; then
            user_arg="-u harbor"
        fi
        "${COMPOSE[@]}" exec \
            ${user_arg} \
            "$service" \
            bash
    else
        "${COMPOSE[@]}" run --rm \
            "$service" \
            bash
    fi
}

initLaravelCheckAndCopyEnv() {
    echo "Checking .env and folders ..."

    if [[ ! -f .env.example ]]; then
        echo "No .env.example file found within current working directory $(pwd), this is not a laravel project, so please run harbor install"
        exit 1
    fi

    # cp .env.example .env if .env is missing
    if [[ ! -f .env ]] && [[ -f .env.example ]]; then
        cp .env.example .env
        echo ".env created from .env.example"
    fi

    return 0
}

initNodeModulesDir() {
    # make dir for node_modules, before docker-compose does
    mkdir -p ./node_modules

    # prevent accidental commits of host node_modules content
    if [[ ! -f ./node_modules/.gitignore ]]; then
        printf "*\n!/.gitignore\n" > ./node_modules/.gitignore
    fi
}

initNpm() {
    echo "Npm ..."

    # Verify package.json exists before installing
    if [[ ! -f package.json ]]; then
        echo "No package.json found, skipping npm steps."
        return 0
    fi

    # Prefer npm ci when a lockfile exists, otherwise npm install
    if [[ -f package-lock.json ]]; then
        ./harbor npm ci
    else
        ./harbor npm install
    fi

    # Build if script exists; fallback to dev if build is missing
    if grep -Eq '"scripts"[^{]*\{[^}]*"build"' package.json; then
        ./harbor npm run build
    elif grep -Eq '"scripts"[^{]*\{[^}]*"dev"' package.json; then
        ./harbor npm run dev
    else
        echo "No build/dev script found in package.json, skipping build step."
    fi
}

initNpmCraftable() {
  initNpm

  # Run craftable-dev only if script exists
  if [[ -f package.json ]] && grep -Eq '"scripts"[^{]*\{[^}]*"craftable-dev"' package.json; then
    ./harbor npm run craftable-dev
  else
    echo "No craftable-dev script found in package.json, skipping."
  fi
}

prepareEnv() {
    echo "Changing .env ..."

    # change values in .env file
    if [[ ! -f .env ]]; then
        echo "No .env file found, skipping environment adjustments."
        return 0
    fi

    # source actual env values and export them for substitutions
    set -o allexport
    source .env
    set +o allexport

    if [[ -z ${DB_PASSWORD:-} ]]; then
        export DB_PASSWORD="bestsecret"
    fi

    # modify values
    ${SEDCMD} "s/APP_URL=.*/APP_URL=http:\/\/localhost:${HARBOR_WEB_PORT}/" .env

    ${SEDCMD} "s/DB_CONNECTION=.*/DB_CONNECTION=${HARBOR_DB_CONNECTION}/" .env
    ${SEDCMD} "s/DB_HOST=.*/DB_HOST=${HARBOR_DB_HOST}/" .env
    ${SEDCMD} "s/DB_PORT=.*/DB_PORT=${HARBOR_DB_PORT}/" .env
    ${SEDCMD} "s/# DB_HOST=.*/DB_HOST=${HARBOR_DB_HOST}/" .env
    ${SEDCMD} "s/# DB_PORT=.*/DB_PORT=${HARBOR_DB_PORT}/" .env

    if [[ -f .env.harbor ]]; then
        set -o allexport
        source .env.harbor
        set +o allexport
    fi
    ${SEDCMD} "s/DB_DATABASE=.*/DB_DATABASE=${DB_DATABASE}/" .env
    ${SEDCMD} "s/DB_USERNAME=.*/DB_USERNAME=${DB_USERNAME}/" .env
    ${SEDCMD} "s/DB_PASSWORD=.*/DB_PASSWORD=${DB_PASSWORD}/" .env
    ${SEDCMD} "s/# DB_DATABASE=.*/DB_DATABASE=${DB_DATABASE}/" .env
    ${SEDCMD} "s/# DB_USERNAME=.*/DB_USERNAME=${DB_USERNAME}/" .env
    ${SEDCMD} "s/# DB_PASSWORD=.*/DB_PASSWORD=${DB_PASSWORD}/" .env

    ${SEDCMD} "s/APP_MAINTENANCE_DRIVER=.*/APP_MAINTENANCE_DRIVER=cache/" .env
    ${SEDCMD} "s/# APP_MAINTENANCE_STORE=.*/APP_MAINTENANCE_STORE=${HARBOR_CACHE_DRIVER}/" .env

    ${SEDCMD} "s/LOG_STACK=.*/LOG_STACK=daily,stderr/" .env

    ${SEDCMD} "s/SESSION_DRIVER=.*/SESSION_DRIVER=${HARBOR_SESSION_DRIVER}/" .env
    ${SEDCMD} "s/QUEUE_CONNECTION=.*/QUEUE_CONNECTION=sync/" .env
    ${SEDCMD} "s/CACHE_DRIVER=.*/CACHE_DRIVER=${HARBOR_CACHE_DRIVER}/" .env
    ${SEDCMD} "s/CACHE_STORE=.*/CACHE_STORE=${HARBOR_CACHE_DRIVER}/" .env
    ${SEDCMD} "s/REDIS_HOST=.*/REDIS_HOST=${HARBOR_REDIS_HOST}/" .env

    # removed bak file (created by BSD sed on mac)
    if [[ -f .env.bak ]]; then
        rm .env.bak
    fi

    # re-source actual env values
    source .env
}

prepareContainers() {
    # need to start first, because it takes time to setup database
    echo "Restarting containers ..."

    # restart docker containers
    ./harbor restart

    # Wait for database using helper script provided in images
    "${COMPOSE[@]}" exec db wait-for-active-database.sh
}

initLaravel() {
    echo "Setting up your docker environment for this laravel based project."

    prepareEnv

    # art key:generate (only if missing or default)
    if [[ -f .env ]]; then
        source .env
    fi
    if [[ -z "${APP_KEY:-}" ]] || [[ "${APP_KEY}" == "SomeRandomString" ]]; then
        echo "Generating APP_KEY ..."
        if ! "${COMPOSE[@]}" run --rm php php artisan key:generate; then
            echo "Failed to generate APP_KEY via artisan. Please check your Laravel installation."
            exit 1
        fi
        # re-source actual env values
        source .env
    fi

    prepareContainers

    echo "Migrating ..."
    # migrate and seed
    ./harbor art migrate --seed

    initNpm

    # stop docker containers
    ./harbor stop

    echo "All set."
}

installLaravel() {
    echo "Installing new laravel application to current folder."

    # remove all containers and volumes (tolerate if not running)
    "${COMPOSE[@]}" down -v || true

    testRunningContainers

    initNodeModulesDir

    # use php container to create laravel application
    echo "Creating Laravel application in temporary 'application' folder ..."
    "${COMPOSE[@]}" run --rm php composer create-project laravel/laravel ./application
    echo "Laravel installed"

    # move sail docker-compose.yml to docker-compose-sail.yml
    if [[ -f application/docker-compose.yml ]]; then
        echo "Move sail docker-compose.yml to docker-compose-sail.yml"
        mv application/docker-compose.yml application/docker-compose-sail.yml
    fi

    # move application content to this folder (include dotfiles)
    echo "Move application contents and remove temp folder"
    if [[ -d application ]]; then
        shopt -s dotglob nullglob
        mv application/* .
        shopt -u dotglob
        rm -rf ./application
    else
        echo "Expected temporary 'application' folder not found. Installation may have failed."
        exit 1
    fi

    echo "Laravel installed"
}

laravel() {
    echo "Starting Laravel installation and initialization ..."

    if ! installLaravel; then
        echo "Laravel installation failed. Aborting."
        exit 1
    fi

    echo "Laravel initializing ..."

    if ! initLaravel; then
        echo "Laravel initialization failed. Aborting."
        exit 1
    fi

    echo "Laravel install + init complete."
}

setCraftableStability() {
    # Ensure composer.json exists before modifying config
    if [[ -f composer.json ]]; then
        if ! "${COMPOSE[@]}" run --rm php composer config minimum-stability dev; then
            echo "Failed to set composer minimum-stability to dev."
            return 1
        fi
        return 0
    else
        echo "composer.json not found; skipping minimum-stability change."
        return 0
    fi
}

# Parse flags for craftable setup; returns 1 if --dev was provided, else 0
parseCraftableFlags() {
    local DEV=0
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --dev)
                DEV=1
                shift 1
                ;;
            *)
                shift 1
                ;;
        esac
    done
    echo "$DEV"
}

craftable() {
    # Determine flags (e.g., --dev)
    local DEV
    DEV="$(parseCraftableFlags "$@")"

    # Install base Laravel application first
    if ! installLaravel; then
        echo "Laravel installation failed. Aborting craftable setup."
        exit 1
    fi


    # Only set composer stability when --dev was provided
    if [[ "$DEV" == "1" ]]; then
        echo "Setting composer minimum-stability to dev ..."
        if ! setCraftableStability; then
            echo "Setting composer stability failed; continuing, but craftable install may fail."
        fi
    fi

    echo "Require craftable ..."
    if ! "${COMPOSE[@]}" run --rm php composer require dejwcake/craftable; then
        echo "Failed to require dejwcake/craftable."
        exit 1
    fi

    echo "Require admin-generator ..."
    if ! "${COMPOSE[@]}" run --rm php composer require --dev dejwcake/admin-generator; then
        echo "Failed to require dejwcake/admin-generator (dev)."
        exit 1
    fi

    echo "Craftable installed, initializing ..."

    prepareEnv

    prepareContainers

    echo "Running craftable install commands ..."
    if ! ./harbor art craftable:test-db-connection; then
        echo "Craftable DB connection test failed."
        exit 1
    fi
    if ! ./harbor art craftable:install; then
        echo "Craftable install command failed."
        exit 1
    fi

    initNpmCraftable

    # stop docker containers
    ./harbor stop

    echo "Craftable setup complete."
}

usage() {
    cat <<'USAGE'
Harbor commands:
  start [services]         - docker compose up -d
  up [services]            - docker compose up
  stop [args]              - docker compose down
  restart                  - stop if running, then start
  pull                     - docker compose pull
  rebuild [flags]          - rebuild images (flags: -v/--volumes, -i/--images, forwards extras to build)
  artisan|art [args]       - run php artisan [args]
  composer|comp [args]     - run composer [args] in php container
  test [args]              - run phpunit
  npm [args]               - run npm in node container
  db [args]                - run psql/mysql in db container
  dump [args]              - run pg_dump/mysqldump in db container
  ssh <service> [root]     - bash into service (php defaults to user 'harbor' unless 'root')
  init laravel|craftable   - initialize existing project
  create-project laravel   - create new laravel app
  create-project craftable [--dev] - create craftable app (optional --dev sets composer minimum-stability dev)
  exec/run [args]          - passthrough to docker compose exec/run
  -v|--version             - print harbor version
  -t|--type                - print service type
  -h|--help                - show this help
USAGE
}

main() {
    # If we pass any arguments...
    if [[ $# -gt 0 ]]; then

        case "$1" in
        #
        # Type and version
        #

        # Get version
        -v | --version)
            printVersion
            exit 0
            ;;

        # Get type
        -t | --type)
            echo ${TYPE}
            exit 0
            ;;

        # Show help
        -h | --help)
            usage
            exit 0
            ;;

        esac

        checkSystemSupport "$@"
        setupEnvVariables "$@"
        touchHistory

        # Source .env, which can over-ride env vars
        if [[ -f .env ]]; then
            source .env
        fi

        prepareExternalVolumes

        case "$1" in
        #
        # Docker commands
        #

        # Start up containers
        start)
            shift 1
            "${COMPOSE[@]}" up -d "$@"
            ;;

        # Start up containers not as daemon
        up)
            shift 1
            "${COMPOSE[@]}" up "$@"
            ;;

        # Stop the containers
        stop)
            shift 1
            "${COMPOSE[@]}" down "$@"
            ;;

        # Restart the containers
        restart)
            if [[ "$EXEC" == "yes" ]]; then
                ./harbor stop
            fi
            ./harbor start
            ;;

        # Rebuild the containers
        pull)
            shift 1
            "${COMPOSE[@]}" pull
            ;;

        # Rebuild the containers
        rebuild)
            shift 1
            rebuild "$@"
            ;;

        #
        # PHP container commands
        #

        # If "artisan" or "art" is used, pass to "artisan" inside a container
        artisan | art)
            shift 1
            artisan "$@"
            ;;

        # If "composer" or "comp" is used, pass to "composer" inside a container
        composer | comp)
            shift 1
            composer "$@"
            ;;

        # If "test" is used, run unit tests, pass any extra arguments to phpunit
        test)
            shift 1
            export APP_ENV="testing"
            "${COMPOSE[@]}" run --rm \
                php \
                ./vendor/bin/phpunit "$@"
            ;;

        css)
            shift 1
            "${COMPOSE[@]}" run --rm php-qa phpcs -s --colors --extensions=php "$@"
            ;;

        csf)
            shift 1
            "${COMPOSE[@]}" run --rm php-qa phpcbf -s --colors --extensions=php "$@"
            ;;

        phpstan|pst)
            shift 1
            "${COMPOSE[@]}" run --rm php-qa phpstan analyse --configuration=phpstan.neon "$@"
            ;;

        phpmd|pmd)
            shift 1
            DIRS=$1
            shift 1
            "${COMPOSE[@]}" run --rm php-qa phpmd ${DIRS} ansi phpmd.xml --suffixes php --baseline-file phpmd.baseline.xml "$@"
            ;;

        deptrac|dpt)
            shift 1
            "${COMPOSE[@]}" run --rm php-qa deptrac analyze "$@"
            ;;

        rector)
            shift 1
            "${COMPOSE[@]}" run --rm php-qa rector "$@"
            ;;

        compatibility|cmp)
            shift 1
            "${COMPOSE[@]}" run --rm php-qa phpcs --standard=.phpcs.compatibility.xml --cache=.phpcs.cache "$@"
            ;;

        composer-normalize|cn)
            shift 1
            "${COMPOSE[@]}" run --rm php-qa composer normalize "$@"
            ;;

        #
        # NPM container commands
        #

        # If "npm" is used, run npm from our node container
        npm)
            shift 1
            "${COMPOSE[@]}" run --rm \
                node \
                npm "$@"
            ;;

        #
        # DB container commands
        #

        # If "db" is used, run psql/mysql from our existing db container
        db)
            shift 1
            db "$@"
            ;;

        # If "pg_dump" is used, run pg_dump from our existing pgsql container
        dump)
            shift 1
            dump "$@"
            ;;

        #
        # Global commands
        #

        # If "ssh" is used, connect to given container with bash
        ssh)
            shift 1
            ssh "$@"
            ;;

        # Sent exec command to docker-compose
        exec)
            shift 1
            "${COMPOSE[@]}" exec "$@"
            ;;

        # Sent run command to docker-compose
        run)
            shift 1
            "${COMPOSE[@]}" run "$@"
            ;;

        #
        # Init and installation commands
        #

        # Initialize harbor for existing project
        init)
            case "$2" in

            # Installing laravel project
            laravel | craftable)
                testRunningContainers
                initLaravelCheckAndCopyEnv
                initNodeModulesDir
                initLaravel
                ;;

            # If not provided, init just standard
            *)
                testRunningContainers
                initNodeModulesDir
                prepareContainers
                ;;
            esac
            ;;

        # Installing new laravel or craftable project
        create-project | new)
            case "$2" in

            # Installing new laravel project
            laravel)
                laravel
                ;;

            # Installing new craftable project
            craftable)
                shift 2
                craftable "$@"
                ;;

            # If not provided, show what to use
            *)
                echo $"Usage: $0 $1 {laravel|craftable}"
                exit 0
                ;;
            esac
            ;;

        # Else, pass args to docker-compose
        *)
            "${COMPOSE[@]}" "$@"
            ;;

        esac
    else
        # Use the docker-compose ps command if nothing else passed through
        "${COMPOSE[@]}" ps
    fi
}

main "$@"
